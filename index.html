<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>患者入力リンク & QR 生成（GROTTI II）</title>
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; }
    body{ margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    .wrap{ max-width:960px; margin:40px auto; padding:0 16px; }
    h1{ font-size:20px; margin:0 0 18px; }
    .card{ background:#0b1220; border:1px solid #1e293b; border-radius:12px; padding:20px; }
    .row{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width:900px){ .row{ grid-template-columns: 1.2fr 1fr; } }
    label{ display:block; font-weight:700; font-size:14px; color:var(--muted); margin-bottom:6px; }
    input{ width:100%; padding:12px 12px; border-radius:10px; border:1px solid #334155; background:#0a1020; color:var(--fg); outline:none; }
    input::placeholder{ color:#718096; }
    .btn{ display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #334155; background:#0a1020; color:var(--fg); cursor:pointer; }
    .btn.primary{ background:linear-gradient(90deg,#3b82f6,#06b6d4); border-color:transparent; }
    .hint{ color:var(--muted); font-size:12px; margin-top:8px; }
    .final{ display:block; margin-top:10px; color:#93c5fd; word-break:break-all; }
    .qrbox{ display:flex; align-items:center; justify-content:center; background:#0a1020; border:1px solid #334155; width:280px; height:280px; border-radius:12px; }
    .bar{ display:flex; gap:10px; margin-top:14px; }
 <style>
/* --- Scroll fix: New Patient フォームを確実にスクロール可能に --- */
html, body { height: 100%; }
body {
  overflow-y: auto !important;           /* 全ページで縦スクロールを許可 */
  overscroll-behavior-y: contain;
  -webkit-overflow-scrolling: touch;     /* iOS の慣性スクロール */
}

/* 100vh問題を回避して、ヘッダーがあっても中身がスクロールできるように */
main, .main, .page, .content {
  min-height: 100dvh;                    /* 動的vhでモバイル対応 */
  overflow-y: auto;                      /* コンテンツ側でも保険で許可 */
}

/* 新規患者ページ（クラス名不明でも効くようにフォームを直接ケア） */
form { 
  max-height: none;                      /* もし固定高があれば無効化 */
}

/* 万が一どこかで overflow: hidden が指定されていた場合の無効化 */
[style*="overflow: hidden"] { overflow: auto !important; }

/* ヘッダーが sticky/fixed の場合に下が隠れないよう保険 */
header { position: sticky; top: 0; z-index: 10; }
body { padding-top: env(safe-area-inset-top); }
</style>

  </style>
  <!-- 安定のCDNJS版：qrcodejs 1.0.0 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>患者入力リンク & QR 生成（GROTTI II）</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>ベースURL（患者入力ページ）</label>
          <input id="base" placeholder="https://.../grotti-patient/" />
          <div class="hint">例：https://ynakazawa1224-byte.github.io/grotti-patient/</div>

          <label style="margin-top:12px;">患者IDのクエリ名</label>
          <input id="qname" placeholder="patient_id" />

          <label style="margin-top:12px;">患者ID</label>
          <input id="pid" placeholder="例：P001" />

          <div class="bar">
            <button id="make" class="btn primary">リンクを作成 & QR生成</button>
            <button id="copyUrl" class="btn">URLをコピー</button>
            <button id="savePng" class="btn">QRをPNGで保存</button>
          </div>

          <a id="final" class="final" href="#" target="_blank"></a>
          <div class="hint">※ PNG保存は生成されたキャンバス画像を保存します。</div>
        </div>

        <div style="display:flex;justify-content:center;align-items:center;">
          <div id="qrBox" class="qrbox">
            <!-- ここにQR（canvas or img）が入る -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // 既定値（入っていなくても動く）
  const DEFAULT_BASE  = 'https://ynakazawa1224-byte.github.io/grotti-patient/';
  const DEFAULT_QNAME = 'patient_id';

  // 要素
  const base   = document.getElementById('base');
  const qname  = document.getElementById('qname');
  const pid    = document.getElementById('pid');
  const make   = document.getElementById('make');
  const final  = document.getElementById('final');
  const qrBox  = document.getElementById('qrBox');
  const copyUrl= document.getElementById('copyUrl');
  const savePng= document.getElementById('savePng');

  // 表示上も実値が入るように（プレースホルダではなく）
  const savedBase  = localStorage.getItem('qr_base');
  const savedQName = localStorage.getItem('qr_qname');
  base.value  = (savedBase  && savedBase.trim())  ? savedBase  : DEFAULT_BASE;
  qname.value = (savedQName && savedQName.trim()) ? savedQName : DEFAULT_QNAME;

  // URL組み立て（ベースやクエリ名が空でも既定値を使う）
  function buildUrl() {
    const b = (base.value || DEFAULT_BASE).trim();
    const q = (qname.value || DEFAULT_QNAME).trim() || DEFAULT_QNAME;
    const p = (pid.value || '').trim();
    if (!b || !p) return '';
    const sep = b.includes('?') ? '&' : '?';
    return `${b}${sep}${encodeURIComponent(q)}=${encodeURIComponent(p)}`;
  }

  // qrcodejs で描画（img になっても canvas になってもOKにする）
  function renderQR(url) {
    // 既存をクリア
    qrBox.innerHTML = '';
    // 白背景のdiv（CSP対策兼ねる）
    const holder = document.createElement('div');
    qrBox.appendChild(holder);

    /* qrcodejs は DOMに <canvas> か <img> を挿入します */
    const qr = new QRCode(holder, {
      text: url,
      width: 256,
      height: 256,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M
    });

    // 生成後に保存ボタンで使えるよう、少し遅延して参照
    setTimeout(() => {
      const child = holder.querySelector('canvas, img');
      if (!child) return;

      // 保存時に参照する用に data 属性へ保持
      savePng.dataset.kind = child.tagName.toLowerCase(); // 'canvas' or 'img'
    }, 100);
  }

  function actMake() {
    const url = buildUrl();
    final.textContent = url || '';
    final.href = url || '#';

    if (!url) {
      qrBox.innerHTML = '';
      alert('患者IDを入力してください（ベースURLは自動補完されます）');
      return;
    }

    // 入力保存
    localStorage.setItem('qr_base', (base.value || DEFAULT_BASE).trim());
    localStorage.setItem('qr_qname', (qname.value || DEFAULT_QNAME).trim());

    renderQR(url);
  }

  make.addEventListener('click', actMake);

  copyUrl.addEventListener('click', async () => {
    const url = buildUrl();
    if (!url) return alert('先にリンクを作成してください');
    try {
      await navigator.clipboard.writeText(url);
      alert('URLをコピーしました');
    } catch (e) {
      alert('コピーに失敗しました');
    }
  });

  // PNG保存（canvas ならそのまま、img なら一度 canvas へ描いてから）
  savePng.addEventListener('click', () => {
    const holder = qrBox.querySelector('div');
    if (!holder) return alert('先にQRを生成してください');

    const child = holder.querySelector('canvas, img');
    if (!child) return alert('QRが見つかりません');

    let canvas;
    if (child.tagName.toLowerCase() === 'canvas') {
      canvas = child;
    } else {
      // img → canvas へ書き出して保存
      canvas = document.createElement('canvas');
      canvas.width = child.naturalWidth || 256;
      canvas.height = child.naturalHeight || 256;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(child, 0, 0, canvas.width, canvas.height);
    }

    const a = document.createElement('a');
    a.download = (pid.value || 'qr') + '.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  // 初期レンダリング（患者IDだけ入れて押せばOKな状態に）
  final.textContent = '';
})();
</script>
</body>
</html>
